<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dimas Ai Pro Chat Canggih</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for modern UI -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* Variabel CSS untuk Kustomisasi Tema Default */
        :root {
            --color-accent: #4f46e5; /* Default: Indigo-600 */
            --color-user-bubble: #3b82f6; /* Default: Blue-500 */
            --chat-font-size: 14px;
        }

        /* Glassmorphism yang sangat kuat (Background Static) */
        .glass-container {
            background-color: rgba(255, 255, 255, 0.08); /* Semi-transparent white */
            backdrop-filter: blur(25px); /* Strong blur effect */
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15); /* Subtle border */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); /* Deep shadow */
        }

        /* Scrollbar kustom */
        .chat-area::-webkit-scrollbar { width: 8px; }
        .chat-area::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        .chat-area::-webkit-scrollbar-track { background-color: transparent; }

        /* Style untuk gelembung pesan */
        .user-message {
            background-color: var(--color-user-bubble); 
            border-radius: 1.5rem 0.5rem 1.5rem 0.5rem;
        }
        .ai-message {
            background-color: rgba(55, 65, 81, 0.8); /* Gray-700 semi-transparent */
            border-radius: 0.5rem 1.5rem 0.5rem 1.5rem;
        }
        .message-content {
            font-size: var(--chat-font-size);
        }
        
        /* Animasi pesan masuk */
        .message-enter { animation: fadeInSlideUp 0.3s ease-out; }
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Indikator loading */
        .loading-cursor {
            display: inline-block;
            width: 8px; height: 8px;
            background-color: #e5e7eb;
            border-radius: 50%;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }
    </style>
</head>
<!-- Pastikan background gelap diaplikasikan langsung di body -->
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4 font-['Inter'] transition-colors duration-500">

    <!-- Main Container -->
    <div class="relative w-full max-w-6xl h-[90vh] flex">
        
        <!-- Chat Application Area -->
        <div id="chat-app" class="glass-container rounded-3xl p-6 transition-all duration-300 flex flex-col flex-grow w-full lg:w-[calc(100%-24rem)]">
            
            <!-- Header -->
            <header class="pb-4 mb-4 border-b border-gray-700/50 flex items-center justify-between">
                <h1 class="text-3xl font-extrabold text-white tracking-wider flex items-center">
                    <i data-lucide="brain-circuit" class="w-8 h-8 mr-3 text-indigo-400" id="header-icon"></i>
                    Dimas Ai Pro
                </h1>
                <!-- Tombol Pengaturan -->
                <button id="settings-toggle" onclick="toggleSettings()"
                        class="p-2 rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-all duration-200"
                        aria-label="Pengaturan">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </header>

            <!-- Chat Area -->
            <main id="chat-area" class="chat-area flex-grow overflow-y-auto space-y-4 mb-4 pr-2 transition-all duration-300">
                <!-- Sambutan Awal/Initial Message -->
                <div class="flex justify-start">
                    <div class="ai-message max-w-3xl p-4 text-white shadow-lg message-enter">
                        <strong class="text-indigo-300">Dimas Ai Pro:</strong> Selamat datang! Saya adalah Dimas Ai Pro, sebuah kecerdasan buatan canggih dan profesional yang dirancang untuk memberikan analisis mendalam dan jawaban yang akurat. 
                        <br><br>
                        Sebagai AI yang selalu terhubung dengan Google Search, Anda bisa bertanya tentang topik apa pun, dari sains terbaru, finansial global, hingga pemecahan kode yang kompleks.
                        <br><br>
                        Silakan mulai dengan pertanyaan pertama Anda!
                    </div>
                </div>
            </main>

            <!-- Input Area -->
            <div class="relative">
                <input type="text" id="user-input" placeholder="Ketik pesan Anda di sini..."
                       class="w-full py-4 pl-5 pr-16 text-white text-base glass-container rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:outline-none placeholder-gray-400 transition-all duration-300"
                       onkeydown="if(event.key === 'Enter') { sendMessage(); }">
                <button id="send-button" onclick="sendMessage()"
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 p-3 rounded-xl transition-all duration-300 shadow-lg"
                        style="background-color: var(--color-accent);"
                        aria-label="Kirim Pesan">
                    <i data-lucide="send" class="w-6 h-6 text-white"></i>
                </button>
                <div id="loading-indicator" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-3" style="display: none;">
                    <div class="loading-cursor mr-1"></div>
                    <div class="loading-cursor mr-1" style="animation-delay: 0.2s;"></div>
                    <div class="loading-cursor" style="animation-delay: 0.4s;"></div>
                </div>
            </div>

            <!-- Error/Status Message Box -->
            <div id="message-box" class="mt-4 p-3 bg-red-800/50 text-red-200 rounded-xl hidden transition-all duration-300"></div>

        </div>

        <!-- Settings Sidebar -->
        <aside id="settings-sidebar" 
               class="glass-container fixed inset-y-0 right-0 w-80 lg:w-80 lg:relative lg:ml-6 transform translate-x-full lg:translate-x-0 rounded-3xl p-6 flex flex-col justify-between transition-transform duration-300 z-20">
            
            <div>
                <div class="flex justify-between items-center mb-6 border-b border-gray-700/50 pb-3">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i data-lucide="sliders" class="w-5 h-5 mr-2 text-indigo-400"></i>
                        Pengaturan
                    </h2>
                    <!-- Close button for mobile -->
                    <button onclick="toggleSettings()" class="lg:hidden p-1 rounded-full text-white/70 hover:bg-white/10" aria-label="Tutup Pengaturan">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>


                <!-- 1. Pengaturan Tema -->
                <div class="mb-6">
                    <label class="block text-gray-300 font-semibold mb-2">Aksen Warna</label>
                    <div class="flex space-x-4">
                        <button onclick="setTheme('default')" class="p-3 rounded-full bg-indigo-600 shadow-md ring-4 ring-offset-2 ring-offset-gray-900 focus:ring-indigo-400 transition-all duration-200" aria-label="Tema Biru-Ungu"></button>
                        <button onclick="setTheme('green')" class="p-3 rounded-full bg-emerald-600 shadow-md ring-4 ring-offset-2 ring-offset-gray-900 focus:ring-emerald-400 transition-all duration-200" aria-label="Tema Hijau"></button>
                        <button onclick="setTheme('red')" class="p-3 rounded-full bg-red-600 shadow-md ring-4 ring-offset-2 ring-offset-gray-900 focus:ring-red-400 transition-all duration-200" aria-label="Tema Merah"></button>
                    </div>
                </div>

                <!-- 2. Pengaturan Font -->
                <div class="mb-6">
                    <label class="block text-gray-300 font-semibold mb-2">Ukuran Teks Chat</label>
                    <div class="flex items-center space-x-3 text-white">
                        <span class="text-xs">A</span>
                        <input type="range" id="font-size-slider" min="12" max="18" value="14" step="1" 
                               oninput="setFontSize(this.value)"
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <span class="text-lg">A</span>
                    </div>
                    <p class="text-right text-gray-400 text-sm mt-1" id="current-font-size">14px</p>
                </div>
            </div>

            <!-- 3. Kontak Telegram -->
            <div class="pt-6 border-t border-gray-700/50">
                <p class="text-gray-300 font-semibold mb-3 flex items-center">
                    <i data-lucide="message-square" class="w-5 h-5 mr-2 text-indigo-400"></i>
                    Hubungi Pembuat Aplikasi
                </p>
                <a href="https://t.me/genshiroaje" target="_blank"
                   class="flex items-center justify-center p-3 rounded-xl bg-blue-500 text-white font-bold hover:bg-blue-600 transition-colors duration-200 shadow-lg">
                    <i data-lucide="send" class="w-5 h-5 mr-2"></i>
                    Telegram: t.me/genshiroaje
                </a>
            </div>
            
        </aside>

        <!-- Overlay untuk Mobile -->
        <div id="settings-overlay" class="fixed inset-0 bg-black/50 z-10 transition-opacity duration-300 hidden" onclick="toggleSettings()"></div>
    </div>

    <script>
        // Inisialisasi Lucide Icons
        lucide.createIcons();

        // Variabel Konfigurasi API
        const API_KEY = "AIzaSyClzuNK3QsdwuSG7KV3EUSKL_fjv1JjxXc"; // Kunci API yang disediakan pengguna
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 9999999;

        // Elemen DOM
        const body = document.body;
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const chatArea = document.getElementById('chat-area');
        const messageBox = document.getElementById('message-box');
        const chatApp = document.getElementById('chat-app');
        const settingsSidebar = document.getElementById('settings-sidebar');
        const settingsOverlay = document.getElementById('settings-overlay');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const currentFontSizeDisplay = document.getElementById('current-font-size');
        const headerIcon = document.getElementById('header-icon');
        
        let chatHistory = [{ role: "model", parts: [{ text: "Selamat datang! Saya adalah Dimas Ai Pro, sebuah kecerdasan buatan canggih dan profesional yang dirancang untuk memberikan analisis mendalam dan jawaban yang akurat. Sebagai AI yang selalu terhubung dengan Google Search, Anda bisa bertanya tentang topik apa pun, dari sains terbaru, finansial global, hingga pemecahan kode yang kompleks. Silakan mulai dengan pertanyaan pertama Anda!" }] }];
        let isSettingsOpen = false;

        // Persona System Instruction untuk Dimas Ai Pro
        const systemPrompt = "Act as a world-class, extremely sophisticated, and highly intelligent AI named 'Dimas Ai Pro'. You are an expert in all fields. Provide helpful, insightful, professional, and detailed answers. Always respond in formal Indonesian (Bahasa Indonesia). Maintain a modern, yet professional and respectful tone.";

        // --- Fungsi Pengaturan UI Kustom ---

        /**
         * Mengubah tema warna aplikasi (aksen)
         * @param {string} themeName Nama tema ('default', 'green', 'red')
         */
        function setTheme(themeName) {
            let accentColor;
            let userBubbleColor;
            
            if (themeName === 'default') {
                accentColor = '#4f46e5'; // Indigo
                userBubbleColor = '#3b82f6'; // Blue
            } else if (themeName === 'green') {
                accentColor = '#10b981'; // Emerald
                userBubbleColor = '#10b981'; 
            } else if (themeName === 'red') {
                accentColor = '#dc2626'; // Red
                userBubbleColor = '#ef4444';
            }
            
            // Set CSS Variables
            document.documentElement.style.setProperty('--color-accent', accentColor);
            document.documentElement.style.setProperty('--color-user-bubble', userBubbleColor);

            // Update elemen yang menggunakan Tailwind
            sendButton.style.backgroundColor = accentColor;
            headerIcon.classList.remove('text-indigo-400', 'text-emerald-400', 'text-red-400');
            if (themeName === 'default') headerIcon.classList.add('text-indigo-400');
            else if (themeName === 'green') headerIcon.classList.add('text-emerald-400');
            else if (themeName === 'red') headerIcon.classList.add('text-red-400');
        }

        /**
         * Mengubah ukuran font pada pesan chat
         * @param {string} size Ukuran font dalam px (misalnya '16')
         */
        function setFontSize(size) {
            document.documentElement.style.setProperty('--chat-font-size', `${size}px`);
            currentFontSizeDisplay.textContent = `${size}px`;
        }

        /**
         * Mengaktifkan/Menonaktifkan sidebar Pengaturan
         */
        function toggleSettings() {
            isSettingsOpen = !isSettingsOpen;
            
            if (isSettingsOpen) {
                // Buka Sidebar
                settingsSidebar.classList.remove('translate-x-full');
                settingsSidebar.classList.add('translate-x-0');
                
                // Atur layout utama (chat)
                chatApp.classList.remove('w-full'); // Agar chat menyusut di desktop
                chatApp.classList.add('lg:w-[calc(100%-24rem)]');

                // Tampilkan overlay di mobile
                if (window.innerWidth < 1024) {
                    settingsOverlay.classList.remove('hidden');
                    settingsSidebar.classList.remove('lg:relative', 'lg:ml-6', 'lg:w-80');
                    settingsSidebar.classList.add('fixed', 'w-full');
                    body.style.overflow = 'hidden'; // Nonaktifkan scroll body
                } else {
                    settingsSidebar.classList.remove('fixed', 'w-full');
                    settingsSidebar.classList.add('lg:relative', 'lg:ml-6', 'lg:w-80');
                }

            } else {
                // Tutup Sidebar
                settingsSidebar.classList.remove('translate-x-0');
                settingsSidebar.classList.add('translate-x-full');

                // Kembalikan layout utama
                chatApp.classList.add('w-full');
                chatApp.classList.remove('lg:w-[calc(100%-24rem)]');
                
                // Sembunyikan overlay dan aktifkan scroll body
                settingsOverlay.classList.add('hidden');
                body.style.overflow = '';
            }
        }
        
        // --- Fungsi Logika Chat API ---

        /**
         * Menampilkan pesan di UI chat
         * @param {string} text Konten pesan
         * @param {string} sender Pengirim ('user' atau 'ai')
         */
        function displayMessage(text, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            messageWrapper.classList.add('message-enter');

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-3xl p-4 shadow-lg transition-all duration-300 message-content`;
            messageBubble.classList.add(sender === 'user' ? 'user-message' : 'ai-message');

            // Konten Pesan
            if (sender === 'ai') {
                // Formatting untuk AI
                const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                                          .replace(/\*(.*?)\*/g, '<em>$1</em>') 
                                          .replace(/^- (.*)/gm, 'â€¢ $1') 
                                          .replace(/(\r\n|\n\r|\r|\n){2,}/g, '<br><br>'); 
                messageBubble.innerHTML = `<strong class="text-indigo-300">Dimas Ai Pro:</strong> ${formattedText}`;
                messageBubble.classList.add('text-white', 'whitespace-pre-wrap');
            } else {
                // Formatting untuk User
                messageBubble.textContent = text;
                messageBubble.classList.add('text-white');
            }

            messageWrapper.appendChild(messageBubble);
            chatArea.appendChild(messageWrapper);
            
            // Scroll ke bawah
            chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' });
        }

        /**
         * Mengaktifkan/Menonaktifkan UI saat loading
         * @param {boolean} isLoading Status loading
         */
        function setLoading(isLoading) {
            userInput.disabled = isLoading;
            sendButton.style.display = isLoading ? 'none' : 'block';
            loadingIndicator.style.display = isLoading ? 'flex' : 'none';
            if (!isLoading) {
                userInput.focus();
            }
        }

        /**
         * Fungsi inti untuk memanggil Gemini API dengan retry
         */
        async function fetchWithRetry(payload, retries = MAX_RETRIES) {
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`API Error ${response.status}: Retrying...`);
                        }
                        const errorData = await response.json();
                        throw new Error(`Kesalahan API: ${errorData.error?.message || response.statusText}`);
                    }

                    return response.json();
                } catch (error) {
                    if (i === MAX_RETRIES - 1) {
                        throw new Error(`Gagal menghubungi server setelah ${MAX_RETRIES} percobaan.`);
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Mengirim pesan ke AI
         */
        async function sendMessage() {
            const userText = userInput.value.trim();
            if (!userText) return;
            if (isSettingsOpen) toggleSettings(); // Tutup settings jika terbuka

            // 1. Tampilkan pesan pengguna
            displayMessage(userText, 'user');

            // 2. Tambahkan pesan ke riwayat
            chatHistory.push({ role: "user", parts: [{ text: userText }] });

            // 3. Bersihkan input dan set loading
            userInput.value = '';
            setLoading(true);

            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // Aktifkan Google Search (Grounding)
                tools: [{ "google_search": {} }], 
            };

            try {
                const result = await fetchWithRetry(payload);
                
                const candidate = result.candidates?.[0];
                let aiResponseText = "Maaf, saya gagal mendapatkan respons yang valid dari Dimas Ai Pro.";

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiResponseText = candidate.content.parts[0].text;
                }

                // 4. Tampilkan respons AI
                displayMessage(aiResponseText, 'ai');

                // 5. Tambahkan respons AI ke riwayat
                chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

                // 6. Cek dan tampilkan sumber (jika ada)
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attr => attr.web?.title)
                        .filter(title => title)
                        .slice(0, 3);

                    if (sources.length > 0) {
                        const sourceText = `<br><span class="text-xs italic text-gray-400">Dimas Ai Pro menggunakan informasi dari: ${sources.join(', ')}...</span>`;
                        const lastAiBubble = chatArea.lastElementChild.querySelector('.ai-message');
                        if (lastAiBubble) {
                             lastAiBubble.innerHTML += sourceText;
                        }
                    }
                }

            } catch (error) {
                console.error("Kesalahan dalam fetching Gemini API:", error);
                displayMessage(`[Kesalahan Koneksi/API] Dimas Ai Pro tidak dapat merespons. ${error.message}`, 'ai');
                chatHistory.pop();
            } finally {
                setLoading(false);
            }
        }

        // --- Initialization ---

        /**
         * Fungsi inisialisasi untuk memuat pengaturan awal
         */
        function initializeApp() {
            // Terapkan pengaturan font default
            setFontSize(fontSizeSlider.value);
            // Terapkan tema default
            setTheme('default');
            // Fokus ke input
            userInput.focus();
            
            // Atur tampilan sidebar untuk desktop
            if (window.innerWidth >= 1024) {
                 settingsSidebar.classList.remove('translate-x-full'); // Pastikan terlihat di desktop
                 // Sidebar secara default terbuka di desktop
                 isSettingsOpen = true; 
                 // Kita tidak memanggil toggleSettings karena class-class sudah diatur di HTML untuk desktop
            }
        }

        window.onload = initializeApp;

    </script>
</body>
</html>

